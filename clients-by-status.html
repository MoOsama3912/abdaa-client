<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© - Abdaa Entalek</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="new-styles.css">
    <!-- Font Awesome (ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¹Ù…Ù„ Ù„Ø¯ÙŠÙƒ) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* (... Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø§ ...) */
        
        .delegates-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 0 20px 20px 20px;
        }

        .delegates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .delegate-card {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .delegate-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .delegate-stats {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ */
        .status-waiting-call { border-right: 4px solid #3B82F6; }
        .status-interested-followup { border-right: 4px solid #10B981; } /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³ Ù„ÙŠØªØ·Ø§Ø¨Ù‚ */
        .status-not-interested { border-right: 4px solid #EF4444; }
        .status-potential-thinking { border-right: 4px solid #F59E0B; } /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³ Ù„ÙŠØªØ·Ø§Ø¨Ù‚ */
        .status-office-meeting { border-right: 4px solid #8B5CF6; } /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³ Ù„ÙŠØªØ·Ø§Ø¨Ù‚ */
        .status-confirmed-donation { border-right: 4px solid #059669; } /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³ Ù„ÙŠØªØ·Ø§Ø¨Ù‚ */
        .status-wrong-number { border-right: 4px solid #6B7280; }
        .all-clients { border-right: 4px solid var(--primary-color); }

        .client-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .client-info h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .client-info p {
            margin: 5px 0;
            color: var(--gray-600);
        }

        .client-actions {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
        }

        .edit-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .edit-btn:hover {
            background: var(--primary-light);
        }

        .filters-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        #search-input, #date-filter, #delegate-filter { /* ØªÙ… Ø¥Ø¶Ø§ÙØ© #delegate-filter Ù‡Ù†Ø§ */
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            flex: 1;
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin: 20px;
        }

        .no-results {
            text-align: center;
            color: var(--gray-500);
            padding: 40px;
        }

        /* ğŸ›‘ --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± --- ğŸ›‘ */

        .data-management-container {
            display: flex;
            flex-wrap: wrap; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§Ù„ØªÙØ§Ù ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin: 0 20px 20px 20px;
            gap: 15px;
        }

        .export-buttons,
        .import-buttons {
            display: flex;
            gap: 10px;
        }

        /* Ø¥Ø®ÙØ§Ø¡ input Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ */
        #upload-excel-input {
            display: none;
        }

        /* Ø¬Ø¹Ù„ Ø§Ù„Ù€ label ÙŠØ¸Ù‡Ø± ÙƒØ²Ø± */
        .import-buttons label.btn {
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .filters-container {
                flex-direction: column;
            }

            .clients-grid {
                grid-template-columns: 1fr;
            }
            
            /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
            .data-management-container {
                flex-direction: column;
                align-items: stretch;
            }
            .export-buttons,
            .import-buttons {
                flex-direction: column;
            }
            .import-buttons label.btn,
            .import-buttons a.btn {
                text-align: center;
            }
        }
        
        /* ğŸ›‘ --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- ğŸ›‘ */
        @media print {
            /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø§ Ù†Ø±ÙŠØ¯Ù‡ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .page-header,
            .delegates-section,
            .filters-container,
            .data-management-container,
            .client-actions,
            .back-button,
            .note,
            #filter-indicator {
                display: none !important;
            }

            /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡ ÙÙ‚Ø· */
            .clients-grid {
                grid-template-columns: 1fr !important;
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }
            
            .client-card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid; /* Ù…Ù†Ø¹ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª */
            }
            
            .content-container {
                margin: 0;
                padding: 0;
            }
            
            h2#status-title {
                text-align: center;
                margin-bottom: 20px;
            }
        }
        
    </style>
    <script src="config.js"></script>
</head>
<body>
    <header class="page-header">
        <div class="logo-container">
            <img src="images/logo.png" alt="Abdaa Entalek Logo">
        </div>
        <a href="dashboard.html" class="back-button">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </header>

    <main class="content-container">
        <h2 id="status-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
        
        <p class="note">Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ <a href="dashboard.html">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>.</p>

        <!-- Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† -->
        <div class="delegates-section">
            <h3>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h3>
            <div id="delegates-list" class="delegates-grid"></div>
        </div>

        <!-- ÙÙ„ØªØ±Ø© ÙˆØ¨Ø­Ø« -->
        <div class="filters-container">
            <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <select id="delegate-filter">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>
            </select>
            <select id="date-filter">
                <option value="all">ÙƒÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</option>
                <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
            </select>
        </div>
        
        <!-- ğŸ›‘ --- Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†Ø·Ù‚Ø© Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- ğŸ›‘ -->
        <div class="data-management-container">
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
            <div class="export-buttons">
                <button id="print-btn" class="btn btn-secondary"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø©</button>
                <button id="export-excel-btn" class="btn btn-primary"><i class="fas fa-file-excel"></i> ØªØ­Ù…ÙŠÙ„ Excel</button>
                <button id="export-pdf-btn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ PDF</button>
            </div>
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø«Ø§Ù„ -->
            <div class="import-buttons">
                <!-- Ù‡Ø°Ø§ Ø§Ù„Ù€ label Ø³ÙŠÙØªØ­ input Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø®ÙÙŠ -->
                <label for="upload-excel-input" class="btn btn-primary">
                    <i class="fas fa-file-upload"></i> Ø±ÙØ¹ Ù…Ù„Ù Excel
                </label>
                <input type="file" id="upload-excel-input" accept=".xlsx, .xls">
                
                <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ (ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ÙˆØ¶Ø¹ Ù…Ù„Ù Ø§Ù„Ù…Ø«Ø§Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±) -->
                <a href="/templates/example.xlsx" id="download-example-link" class="btn btn-secondary" download>
                    <i class="fas fa-file-download"></i> ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„
                </a>
            </div>
        </div>
        <!-- ğŸ›‘ --- Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø·Ù‚Ø© Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª --- ğŸ›‘ -->


        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div id="clients-list" class="clients-grid"></div>
    </main>

    <script src="config.js"></script>
    <!-- ğŸ›‘ --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ JavaScript --- ğŸ›‘ -->
    <script>
        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹)
        function editClient(id) {
            window.location.href = `edit-client.html?id=${id}`;
        }
        // -------------------------------------------------------------

        /**
         * Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (Retry) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Exponential Backoff
         * @param {string} url - Ø¹Ù†ÙˆØ§Ù† URL Ù„Ù„Ø¬Ù„Ø¨.
         * @param {object} options - Ø®ÙŠØ§Ø±Ø§Øª fetch.
         * @param {number} retries - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù‚ØµÙˆÙ‰.
         */
        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© 404 Ø£Ùˆ 500 Ø£Ùˆ Ø£ÙŠ Ø®Ø·Ø£ Ø¢Ø®Ø±ØŒ Ø§Ø±ÙØ¹ Ø®Ø·Ø£ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                        throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (2^i Ø«ÙˆØ§Ù†Ù)
                        const delay = Math.pow(2, i) * 1000;
                        console.log(`[Fetch Retry] Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ ÙØ§Ø´Ù„Ø© Ù„Ù„Ø±Ø§Ø¨Ø·: ${url}. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… ${i + 1}/${retries}. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${delay / 1000} Ø«ÙˆØ§Ù†Ù...`);
                        // Ø§Ù†ØªØ¸Ø± Ù„Ù…Ø¯Ø© (Delay) Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ´Ù„ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                        throw new Error("Failed to fetch after multiple retries: " + error.message);
                    }
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            const clientsList = document.getElementById('clients-list');
            const searchInput = document.getElementById('search-input');
            const dateFilter = document.getElementById('date-filter');
            const delegateFilter = document.getElementById('delegate-filter');
            const statusTitleEl = document.getElementById('status-title'); 
            const delegatesListEl = document.getElementById('delegates-list');

            const urlParams = new URLSearchParams(window.location.search);
            const statusParam = urlParams.get('status');
            const delegateParam = urlParams.get('delegate');

            const filterIndicatorContainer = document.createElement('div');
            filterIndicatorContainer.id = 'filter-indicator';
            filterIndicatorContainer.className = 'note';
            filterIndicatorContainer.style.margin = '0 20px 20px 20px';
            filterIndicatorContainer.style.display = 'none';
            document.querySelector('.content-container').insertBefore(filterIndicatorContainer, statusTitleEl.nextSibling);

            let allClients = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ©)
            let initialFilteredClients = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            let allDelegates = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
            
            // ----------------------------------------------------------------
            // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
            // ----------------------------------------------------------------
            function showFilterIndicator(name) {
                if (!filterIndicatorContainer) return;
                if (!name) {
                    filterIndicatorContainer.style.display = 'none';
                    return;
                }
                filterIndicatorContainer.style.display = 'block';
                filterIndicatorContainer.innerHTML = `
                    <strong>ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…ÙØ·Ø¨Ù‚:</strong> ${name}
                    <button id="clear-delegate-filter" class="edit-btn" style="margin-right:12px;padding:6px 10px;font-size:0.9em">Ù…Ø³Ø­ ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</button>
                `;
                document.getElementById('clear-delegate-filter').addEventListener('click', () => {
                    urlParams.delete('delegate');
                    window.location.href = window.location.pathname + (urlParams.toString() ? ('?' + urlParams.toString()) : '');
                });
            }

            function displayClients(clients) {
                if (clients.length === 0) {
                    clientsList.innerHTML = '<p class="no-results">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø´Ø±ÙˆØ· Ø§Ù„ØªØµÙÙŠØ©.</p>';
                    return;
                }

                clientsList.innerHTML = clients.map(client => {
                    const delegateName = (typeof client.delegate === 'object' && client.delegate !== null) 
                                        ? client.delegate.name 
                                        : (allDelegates.find(d => d._id === client.delegate)?.name || client.delegate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                    
                    const statusSlug = (client.status || '').replace(/\s+/g, '-').toLowerCase() || 'all-clients';

                    return `
                        <div class="client-card status-${statusSlug}">
                            <div class="client-info">
                                <h3>${client.name}</h3>
                                <p class="status"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${client.status || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                                <p class="delegate"><strong>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</strong> ${delegateName}</p>
                                <p class="phone">ğŸ“± ${client.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                                <p class="date">ğŸ“… ${new Date(client.createdAt).toLocaleDateString('ar-EG')}</p>
                                ${client.notes ? `<p class="notes">ğŸ“ ${client.notes.substring(0, 50)}${client.notes.length > 50 ? '...' : ''}</p>` : ''}
                            </div>
                            <div class="client-actions">
                                <button onclick="editClient('${client._id}')" class="edit-btn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ----------------------------------------------------------------
            // 2. Ø¯Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ¬Ù…Ø¹ Ø§Ù„ÙƒÙ„)
            // ----------------------------------------------------------------
            function applyAllFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const dateValue = dateFilter.value;
                const selectedDelegate = delegateFilter.value;

                let filtered = initialFilteredClients; // Ø§Ø¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ø§Ù„Ø­Ø§Ù„Ø© + Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ URL)

                if (searchTerm) {
                    filtered = filtered.filter(client => 
                        (client.name && client.name.toLowerCase().includes(searchTerm)) ||
                        (client.phone && client.phone.includes(searchTerm))
                    );
                }

                // Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù€ select (Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù…Ù† Ø§Ù„Ù€ URL)
                if (selectedDelegate !== 'all') {
                    filtered = filtered.filter(client => {
                        const del = client.delegate;
                        if (!del) return false;
                        return (typeof del === 'object' && del !== null && del._id === selectedDelegate) || (del === selectedDelegate);
                    });
                }
                
                if (dateValue !== 'all') {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filtered = filtered.filter(client => {
                        const createdAt = new Date(client.createdAt);
                        let filterDate;
                        switch(dateValue) {
                            case 'today': filterDate = today; break;
                            case 'week': filterDate = new Date(today); filterDate.setDate(filterDate.getDate() - 7); break;
                            case 'month': 
                                filterDate = new Date(today); 
                                filterDate.setMonth(filterDate.getMonth() - 1); // Fix: use filterDate instead of monthAgo
                                break;
                            default: return true;
                        }
                        return createdAt >= filterDate;
                    });
                }
                
                displayClients(filtered);
            }

            // ----------------------------------------------------------------
            // 3. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
            // ----------------------------------------------------------------
            try {
                // ğŸ›‘ --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙˆØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø§Ø± /api/) --- ğŸ›‘
                const API_URL_BASE = window.API_BASE || 'https://abdaa-server.vercel.app';
                
                const [clientsRes, delegatesRes] = await Promise.all([
                    // Ù†Ø­Ø§ÙˆÙ„ Ù…Ø¹ Ù…Ø³Ø§Ø± /api/clients Ù„Ø£Ù†Ù‡Ø§ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹ Ù„Ø®ÙˆØ§Ø¯Ù… Ø§Ù„Ù€ REST
                    fetchWithRetry(`${API_URL_BASE}/api/clients`, { mode: 'cors' }, 3),
                    fetchWithRetry(`${API_URL_BASE}/api/delegates`, { mode: 'cors' }, 3)
                ]);
                // ğŸ›‘ --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ --- ğŸ›‘

                // Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­ØªØ§Ø¬ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ok Ù‡Ù†Ø§ Ù„Ø£Ù† fetchWithRetry ÙŠØªÙˆÙ„Ù‰ Ø±ÙØ¹ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¬ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                
                allClients = await clientsRes.json();
                allDelegates = await delegatesRes.json();
                initialFilteredClients = [...allClients]; // Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒÙ„

                // ØªØ¹Ø¨Ø¦Ø© ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ø¨Ù€ _id)
                if (delegateFilter) {
                    delegateFilter.innerHTML = `
                        <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>
                        ${allDelegates.map(d => `<option value="${d._id}">${d.name}</option>`).join('')}
                    `;
                }

                // Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
                if (delegatesListEl) {
                    delegatesListEl.innerHTML = allDelegates.map(delegate => `
                        <a href="clients-by-status.html?delegate=${delegate._id}&status=${statusParam || 'all'}" class="delegate-card">
                            <div class="delegate-name">${delegate.name}</div>
                            <div class="delegate-stats">${delegate.clientsCount ? `Ø¹Ù…Ù„Ø§Ø¡ (${delegate.clientsCount})` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡'}</div>
                        </a>
                    `).join('');
                }

                // ----------------------------------------------------------------
                // 4. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù€ URL
                // ----------------------------------------------------------------
                let delegateNameForTitle = '';

                if (statusParam && statusParam !== 'all') {
                    initialFilteredClients = initialFilteredClients.filter(client => client.status === statusParam);
                    statusTitleEl.textContent = `Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ${statusParam}`;
                    document.title = `Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ${statusParam} - Abdaa Entalek`;
                } else {
                    statusTitleEl.textContent = `ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡`;
                    document.title = `ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Abdaa Entalek`;
                }

                if (delegateParam && delegateParam !== 'all') {
                    const decodedDelegate = decodeURIComponent(delegateParam);
                    const matchedDelegate = allDelegates.find(d => d._id === decodedDelegate || d.name === decodedDelegate);
                    
                    if (matchedDelegate) {
                        delegateFilter.value = matchedDelegate._id;
                        delegateNameForTitle = matchedDelegate.name;
                        initialFilteredClients = initialFilteredClients.filter(client => {
                            const del = client.delegate;
                            return (typeof del === 'object' && del !== null && del._id === matchedDelegate._id) || (del === matchedDelegate._id);
                        });
                    }
                    showFilterIndicator(delegateNameForTitle || decodedDelegate);
                }

                // ----------------------------------------------------------------
                // 5. Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
                // ----------------------------------------------------------------
                
                searchInput.addEventListener('input', applyAllFilters);
                dateFilter.addEventListener('change', applyAllFilters);
                
                // (Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ select ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ URL)
                delegateFilter.addEventListener('change', (e) => {
                    const val = e.target.value;
                    if (val === 'all') {
                        urlParams.delete('delegate');
                    } else {
                        urlParams.set('delegate', val);
                    }
                    window.location.href = window.location.pathname + (urlParams.toString() ? ('?' + urlParams.toString()) : '');
                });

                // ğŸ›‘ --- Ø¨Ø¯Ø§ÙŠØ© Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- ğŸ›‘
                const printBtn = document.getElementById('print-btn');
                const exportExcelBtn = document.getElementById('export-excel-btn');
                const exportPdfBtn = document.getElementById('export-pdf-btn');
                const uploadExcelInput = document.getElementById('upload-excel-input');

                // Ø£. Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                printBtn.addEventListener('click', () => {
                    // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙÙŠ @media print Ø³ØªØªÙˆÙ„Ù‰ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                    window.print();
                });

                // Ø¨. Ø²Ø± ØªØ­Ù…ÙŠÙ„ Excel (ÙŠØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© SheetJS/xlsx.js)
                exportExcelBtn.addEventListener('click', () => {
                    alert('ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ Excel (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±) - ØªØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ©.');
                    // 1. ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ù…ÙƒØªØ¨Ø© (Ù…Ø«Ù„ SheetJS)
                    // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© (Ù…Ù† initialFilteredClients Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©)
                    console.log('Exporting data to Excel...', initialFilteredClients); 
                    // 3. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel ÙˆØªØ­Ù…ÙŠÙ„Ù‡
                });

                // Ø¬. Ø²Ø± ØªØ­Ù…ÙŠÙ„ PDF (ÙŠØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© jsPDF)
                exportPdfBtn.addEventListener('click', () => {
                    alert('ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ PDF (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±) - ØªØªØ·Ù„Ø¨ Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ©.');
                    // 1. ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ù…ÙƒØªØ¨Ø© (Ù…Ø«Ù„ jsPDF Ùˆ jsPDF-AutoTable)
                    console.log('Exporting data to PDF...', initialFilteredClients);
                    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF ÙˆØªØ­Ù…ÙŠÙ„Ù‡
                });

                // Ø¯. Ø²Ø± Ø±ÙØ¹ Excel
                uploadExcelInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    alert(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù: ${file.name}. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±ÙØ¹ (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±).`);
                    console.log('File selected:', file);
                    
                    // 1. ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ù…ÙƒØªØ¨Ø© (Ù…Ø«Ù„ SheetJS) Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
                    // 2. Ø¥Ù†Ø´Ø§Ø¡ FormData
                    const formData = new FormData();
                    formData.append('clientsFile', file);

                    // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù…Ø³Ø§Ø± Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±)
                    try {
                        /*
                        const response = await fetch(`${API_URL_BASE}/api/clients/bulk-upload`, {
                            method: 'POST',
                            body: formData
                            // (Ù„Ø§ ØªØ¶Ø¹ Content-Type: application/json Ù‡Ù†Ø§)
                        });
                        if (!response.ok) throw new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
                        alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­!');
                        location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                        */
                    } catch (uploadError) {
                        console.error('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹:', uploadError);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.');
                    }
                });
                // ğŸ›‘ --- Ù†Ù‡Ø§ÙŠØ© Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- ğŸ›‘

                // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                displayClients(initialFilteredClients);

            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
                clientsList.innerHTML = `<p class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${err.message}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆÙ…Ù† ØµØ­Ø© Ù…Ø³Ø§Ø± API (Ø¨Ù€ /api/ Ø£Ùˆ Ø¨Ø¯ÙˆÙ†Ù‡Ø§) ÙˆØ­Ù„ Ù…Ø´ÙƒÙ„Ø© CORS.</p>`;
            }
        });
    </script>
</body>
</html>